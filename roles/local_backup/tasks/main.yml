---

- name: Create backups directory if it does not exist
  ansible.builtin.file:
    path: "{{ local_backup_destination }}"
    state: directory
    owner: root
    group: root
    mode: 0775

- name: Make sure backup destination exists.
  ansible.builtin.file:
    path: "{{ local_backup_destination }}"
    state: directory
    mode: 0755

- name: Copy local_backup.sh.
  ansible.builtin.template:
    src: templates/local_backup.sh.j2
    dest: "{{ files_path }}/scripts/local_backup.sh"
    owner: root
    group: root
    mode: 0755

- name: Initialize an empty string for local backup paths.
  ansible.builtin.set_fact:
    backup_directories_string: ""
  when: local_backup_paths | length > 0

- name: Generate string of local backup paths.
  ansible.builtin.set_fact:
    backup_directories_string: "{{ backup_directories_string }} {{ item }}"
  with_items: "{{ local_backup_paths }}"
  when: local_backup_paths | length > 0

- name: Add cron job for local backup script.
  ansible.builtin.cron:
    name: "Local backup."
    minute: "0"
    hour: "3"
    job: "bash {{ files_path }}/scripts/local_backup.sh{{ backup_directories_string }}"
  when: local_backup_paths | length > 0
