#!/usr/bin/env bash

## Configuration
LOG_DIR="{{ cloud_backup_log_dir }}"

{% raw %}

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/base.sh"

# PUT SCRIPT INFO IN HERE
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    echo "Kopia to BackBlaze backup for specified path."
    exit 0
fi

# Check that a path argument has been given.
if [ -z "$1" ]; then
        error_exit "No path arguments supplied."
fi

for backup_dir in "$@"; do

    log "Cloud backup of path $backup_dir starting"

    # Check if another instance of kopia is running
    pidof -o %PPID -x kopia >/dev/null && error_exit "Kopia is already running"

    # Check that path has files in it
    if [ ! "$(ls -A "$backup_dir")" ]; then
        error_exit "Path $backup_dir empty."
        exit
    fi

    # Everything goes to file. Maybe should be 2> | tee -a file
    kopia snapshot "$backup_dir" --file-log-level=info --log-dir "$LOG_DIR"
    response=$?
    if [ $response -ne 0 ]; then
        error_exit "Kopia command failed."
    fi

done

log "Cloud backup of path $backup_dir finished!"

{% endraw %}